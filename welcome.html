<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome Page</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="welcome-container">
        <div class="profile-pic-container">
            <img src="profile.png" alt="Profile Picture" class="profile-pic">
        </div>
        <h1 class="welcome-message">Welcome, <span id="realname">[Your Name]</span>!</h1>
        <p id="data-count-message">Loading data...</p>

        <button class="entry-button" onclick="toggleEntryForm()">Entry Data</button>

        <!-- Form untuk input data -->
        <div id="entry-form-container" style="display:none;">
            <h3>Input Data</h3>
            <form id="entry-form">
                <div>
                    <label for="nomor_tps">Nomor TPS:</label>
                    <input type="text" id="nomor_tps" name="nomor_tps" required>
                </div>
                <div>
                    <label for="jumlah_suara_sah">Jumlah Suara Sah:</label>
                    <input type="number" id="jumlah_suara_sah" name="jumlah_suara_sah" required>
                </div>
                <div>
                    <label for="jumlah_suara_tidak_sah">Jumlah Suara Tidak Sah:</label>
                    <input type="number" id="jumlah_suara_tidak_sah" name="jumlah_suara_tidak_sah" required>
                </div>
                <button type="submit" class="submit-button">Submit Data</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <!-- JavaScript to handle data entry and display -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBF2gLqtLL6msiugN7fuMlMK5278rJpsQ",
            authDomain: "quickcount-9e634.firebaseapp.com",
            projectId: "quickcount-9e634",
            storageBucket: "quickcount-9e634.appspot.com",
            messagingSenderId: "855202720175",
            appId: "1:855202720175:web:cc9ead847ec6c67b70275a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Function to get cookie value by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Get the realname cookie saved after login
        const realname = getCookie('realname');
        console.log('Realname from cookie:', realname);  // Log to check if realname is retrieved correctly

        // If the realname cookie is found, display it on the page
        if (realname) {
            document.getElementById('realname').textContent = realname;

            // Fetch data from Firestore where the realname matches
            db.collection('suara').where('koordinator_saksi', '==', realname)
                .get()
                .then((querySnapshot) => {
                    const dataCount = querySnapshot.size;
                    document.getElementById('data-count-message').textContent = `You have submitted ${dataCount} entries.`;
                })
                .catch((error) => {
                    console.error('Error fetching data:', error);
                    document.getElementById('data-count-message').textContent = 'Error loading data.';
                });
        } else {
            // If no cookie is found, redirect back to the login page
            window.location.href = "index.html";
        }

        // Function to toggle the display of the entry form
        function toggleEntryForm() {
            const formContainer = document.getElementById('entry-form-container');
            if (formContainer.style.display === 'none') {
                formContainer.style.display = 'block';
            } else {
                formContainer.style.display = 'none';
            }
        }

        // Handle form submission and save data to Firestore
        document.getElementById('entry-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get values from form inputs
            const nomor_tps = document.getElementById('nomor_tps').value;
            const jumlah_suara_sah = document.getElementById('jumlah_suara_sah').value;
            const jumlah_suara_tidak_sah = document.getElementById('jumlah_suara_tidak_sah').value;

            try {
                // Add new data to Firestore
                await db.collection('suara').add({
                    nomor_tps: nomor_tps,
                    jumlah_suara_sah: jumlah_suara_sah,
                    jumlah_suara_tidak_sah: jumlah_suara_tidak_sah,
                    koordinator_saksi: realname, // Attach the user's realname from cookie
                    waktu: firebase.firestore.FieldValue.serverTimestamp() // Store the time of submission
                });

                // Inform the user that the data was successfully saved
                alert('Data successfully submitted!');

                // Reset the form after submission
                document.getElementById('entry-form').reset();

                // Hide the form after submission
                toggleEntryForm();
            } catch (error) {
                console.error('Error saving data to Firestore:', error);
                alert('Failed to submit data. Please try again.');
            }
        });
    </script>
</body>
</html>
